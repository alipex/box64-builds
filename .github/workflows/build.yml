name: Build box64

on:
#  push:
#    tags:
#      - '*'
#  release:            
#    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Box64 version to build (leave empty for latest)'
        required: false
        default: ''

jobs:
  build:
    name: Build Box64
    runs-on: self-hosted
    strategy:
      matrix:
        arch: [arm64, rv64]
    env:
      BOX64_REPO: https://github.com/ptitSeb/box64.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set version
        id: set_version
        run: |
          VERSION_INPUT="${{ github.event.inputs.version }}"
          VERSION=""

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "$VERSION_INPUT" ]]; then
            VERSION="$VERSION_INPUT"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            latest_tag=$(git ls-remote --tags $BOX64_REPO | awk -F/ '{print $3}' | sort -V | tail -n1)
            VERSION="$latest_tag"
          fi

          echo "Using version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            gcc-riscv64-linux-gnu g++-riscv64-linux-gnu

      - name: Clone ptitSeb/Box64
        run: |
          git clone $BOX64_REPO box64-source
          cd box64-source
          if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
            git checkout tags/$VERSION
          else
            git checkout main
          fi

      - name: Check support for flags
        id: check_arch
        run: |
          skip_build=false
          skip_optimized=false
          ver=$(echo ${{ env.version }} | sed 's/v//')
          ver_num=$(echo $ver | awk -F. '{printf("%d%02d%02d",$1,$2,$3)}')

          # RISC-V support from v0.1.8
          if [[ "${{ matrix.arch }}" == "rv64" && $ver_num -lt 10800 ]]; then
            skip_build=true
          fi

          # DynaRec support
          if [[ "${{ matrix.arch }}" == "arm64" && $ver_num -lt 6 ]]; then
            skip_optimized=true
          elif [[ "${{ matrix.arch }}" == "rv64" && $ver_num -lt 204 ]]; then
            skip_optimized=true
          fi

          echo "skip_build=$skip_build" >> $GITHUB_ENV
          echo "skip_optimized=$skip_optimized" >> $GITHUB_ENV

      - name: Build regular and optimized versions
        if: env.skip_build != 'true'
        run: |
          mkdir -p artifacts
          WORKDIR=$GITHUB_WORKSPACE
          SOURCE_DIR=$WORKDIR/box64-source

          for BUILD_TYPE in "regular" "optimized"; do
            if [[ "$BUILD_TYPE" == "optimized" && "${{ env.skip_optimized }}" == "true" ]]; then
              echo "Skipping optimized build for ${{ matrix.arch }} as DynaRec is not supported."
              continue
            fi

            BUILD_DIR=$WORKDIR/build-${BUILD_TYPE}-${{ matrix.arch }}
            mkdir -p $BUILD_DIR

            FLAGS="-DCMAKE_BUILD_TYPE=Release"
            if [[ "$BUILD_TYPE" == "optimized" ]]; then
              FLAGS="$FLAGS -DBUILD_DYNAREC=ON"
            else
              FLAGS="$FLAGS -DBUILD_DYNAREC=OFF"
            fi

            if [[ $ver_num -ge 30302 ]]; then
              FLAGS="$FLAGS -DBUILD_BOX32=ON"
            fi

            if [[ "${{ matrix.arch }}" == "arm64" ]]; then
              SYSTEM_PROCESSOR="aarch64"
              C_COMPILER="aarch64-linux-gnu-gcc"
              CXX_COMPILER="aarch64-linux-gnu-g++"
            else
              SYSTEM_PROCESSOR="riscv64"
              C_COMPILER="riscv64-linux-gnu-gcc"
              CXX_COMPILER="riscv64-linux-gnu-g++"
            fi

            cd $BUILD_DIR
            cmake $SOURCE_DIR \
              -DCMAKE_SYSTEM_NAME=Linux \
              -DCMAKE_SYSTEM_PROCESSOR=$SYSTEM_PROCESSOR \
              -DCMAKE_C_COMPILER=$C_COMPILER \
              -DCMAKE_CXX_COMPILER=$CXX_COMPILER \
              $FLAGS || { echo "CMake configuration failed"; exit 1; }

            make -j$(nproc) || { echo "make failed"; exit 1; }

            OUTPUT_NAME="box64-${{ env.version }}-${BUILD_TYPE}-${{ matrix.arch }}"

            # search for binary using absolute paths
            BINARY_PATH=$(find $BUILD_DIR $SOURCE_DIR -type f -name "box64" -executable | head -n1)
            if [[ -f "$BINARY_PATH" ]]; then
              cp "$BINARY_PATH" $WORKDIR/artifacts/${OUTPUT_NAME}
            else
              echo "Error: box64 binary not found in $BUILD_DIR or $SOURCE_DIR"
              echo "Contents of $BUILD_DIR:"
              find $BUILD_DIR
              echo "Contents of $SOURCE_DIR:"
              find $SOURCE_DIR
              exit 1
            fi

            echo "${OUTPUT_NAME}" >> $WORKDIR/release_outputs.txt
          done

      - name: Collect compiled binaries
        if: env.skip_build != 'true'
        id: collect_artifacts
        run: |
          files=()
          for f in artifacts/*; do
            files+=("\"$f\"")
          done
          printf "[%s]\n" "$(IFS=,; echo "${files[*]}")" > files.json
          echo "list=$(cat files.json)" >> $GITHUB_OUTPUT
        
      - name: Upload compiled binaries to artifacts
        if: env.skip_build != 'true'
        uses: actions/upload-artifact@v4
        strategy:
          matrix:
            file: ${{ fromJson(steps.collect_artifacts.outputs.list) }}
        with:
          name: ${{ matrix.file }}
          path: ${{ matrix.file }}
          if-no-files-found: error

#      - name: Create github release
#        if: env.skip_build != 'true'
#        uses: softprops/action-gh-release@v1
#        with:
#          tag_name: ${{ github.ref_name || env.version }}
#          name: "box64 ${{ github.ref_name || env.version }}"
#          body: Automated build for version ${{ github.ref_name || env.version }}
#          draft: false
#          prerelease: ${{ github.event_name != 'release' && github.event_name != 'push' }}
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Upload release artifacts
#        if: env.skip_build != 'true'
#        uses: softprops/action-gh-release@v1
#        with:
#          files: artifacts/*
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set release outputs
        if: env.skip_build != 'true'
        run: |
          while read output; do
            echo "release_output=${output}" >> $GITHUB_OUTPUT
          done < release_outputs.txt
