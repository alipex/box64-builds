name: Build box64

on:
  #push:
  #  branches:
  #    - main
  #    - master
  #release:
  #  types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Box64 version/tag to build (leave empty if using commit SHA)'
        required: false
        default: ''
      commit:
        description: 'Box64 commit SHA to build (leave empty to use version or latest tag)'
        required: false
        default: ''

jobs:
  build:
    name: Build Box64
    runs-on: self-hosted
    strategy:
      matrix:
        arch: [arm64, rv64]
    env:
      BOX64_REPO: https://github.com/ptitSeb/box64.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Decide what to build (version/tag or commit)
        id: set_version
        run: |
          VERSION_INPUT="${{ github.event.inputs.version }}"
          COMMIT_INPUT="${{ github.event.inputs.commit }}"
          REF=""
          REF_TYPE=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "$COMMIT_INPUT" ]]; then
            REF="$COMMIT_INPUT"
            REF_TYPE="commit"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "$VERSION_INPUT" ]]; then
            REF="$VERSION_INPUT"
            REF_TYPE="version"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF="${GITHUB_REF#refs/tags/}"
            REF_TYPE="version"
          else
            latest_tag=$(git ls-remote --tags $BOX64_REPO | awk -F/ '{print $3}' | sort -V | tail -n1)
            REF="$latest_tag"
            REF_TYPE="version"
          fi
          echo "ref=$REF" >> $GITHUB_ENV
          echo "reftype=$REF_TYPE" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            gcc-riscv64-linux-gnu g++-riscv64-linux-gnu

      - name: Clone ptitSeb/Box64 at desired ref
        run: |
          git clone $BOX64_REPO box64-source
          cd box64-source
          if [[ "${{ env.reftype }}" == "commit" ]]; then
            git checkout ${{ env.ref }}
          elif git rev-parse "refs/tags/${{ env.ref }}" >/dev/null 2>&1; then
            git checkout "tags/${{ env.ref }}"
          else
            git checkout main
          fi

      - name: Check support for flags
        id: check_arch
        run: |
          skip_build=false
          skip_dynarec=false
          ver=$(echo ${{ env.ref }} | sed 's/v//')
          ver_num=$(echo $ver | awk -F. '{printf("%d%02d%02d",$1,$2,$3)}')
          # RISC-V support from v0.1.8
          if [[ "${{ matrix.arch }}" == "rv64" && $ver_num -lt 10800 ]]; then
            skip_build=true
          fi
          # Dynarec support
          if [[ "${{ matrix.arch }}" == "arm64" && $ver_num -lt 6 ]]; then
            skip_dynarec=true
          elif [[ "${{ matrix.arch }}" == "rv64" && $ver_num -lt 204 ]]; then
            skip_dynarec=true
          fi
          echo "skip_build=$skip_build" >> $GITHUB_ENV
          echo "skip_dynarec=$skip_dynarec" >> $GITHUB_ENV

      - name: Build variants
        if: env.skip_build != 'true'
        run: |
          mkdir -p artifacts
          WORKDIR=$GITHUB_WORKSPACE
          SOURCE_DIR=$WORKDIR/box64-source

          for BUILD_TYPE in "regular" "dynarec"; do
            if [[ "$BUILD_TYPE" == "dynarec" && "${{ env.skip_dynarec }}" == "true" ]]; then
              echo "Skipping dynarec build for ${{ matrix.arch }} as support is not available."
              continue
            fi

            for BOX32 in "off" "on"; do
              # Determine artifact name
              if [[ "${{ env.reftype }}" == "commit" ]]; then
                REF="${{ env.ref }}"
              else
                REF="${{ env.ref }}"
              fi

              if [[ "$BUILD_TYPE" == "dynarec" ]]; then
                TYPE_SUFFIX="dynarec"
              else
                TYPE_SUFFIX="regular"
              fi

              if [[ $ver_num -ge 30302 && "$BOX32" == "on" ]]; then
                BOX32_FLAG="-DBUILD_BOX32=ON"
                BOX32_SUFFIX="box32"
                ARTIFACT_NAME="box64-${REF}-${{ matrix.arch }}-${TYPE_SUFFIX}-box32"
              else
                BOX32_FLAG="-DBUILD_BOX32=OFF"
                BOX32_SUFFIX=""
                ARTIFACT_NAME="box64-${REF}-${{ matrix.arch }}-${TYPE_SUFFIX}"
              fi

              BUILD_DIR=$WORKDIR/build-${TYPE_SUFFIX}-box32${BOX32}-${{ matrix.arch }}
              mkdir -p $BUILD_DIR

              FLAGS="-DCMAKE_BUILD_TYPE=Release $BOX32_FLAG"
              if [[ "$BUILD_TYPE" == "dynarec" ]]; then
                FLAGS="$FLAGS -DBUILD_DYNAREC=ON"
              else
                FLAGS="$FLAGS -DBUILD_DYNAREC=OFF"
              fi

              if [[ "${{ matrix.arch }}" == "arm64" ]]; then
                SYSTEM_PROCESSOR="aarch64"
                C_COMPILER="aarch64-linux-gnu-gcc"
                CXX_COMPILER="aarch64-linux-gnu-g++"
              else
                SYSTEM_PROCESSOR="riscv64"
                C_COMPILER="riscv64-linux-gnu-gcc"
                CXX_COMPILER="riscv64-linux-gnu-g++"
              fi

              cd $BUILD_DIR
              cmake $SOURCE_DIR \
                -DCMAKE_SYSTEM_NAME=Linux \
                -DCMAKE_SYSTEM_PROCESSOR=$SYSTEM_PROCESSOR \
                -DCMAKE_C_COMPILER=$C_COMPILER \
                -DCMAKE_CXX_COMPILER=$CXX_COMPILER \
                $FLAGS || { echo "CMake configuration failed"; exit 1; }

              make -j$(nproc) || { echo "make failed"; exit 1; }

              BINARY_PATH=$(find $BUILD_DIR $SOURCE_DIR -type f -name "box64" -executable | head -n1)
              if [[ -f "$BINARY_PATH" ]]; then
                cp "$BINARY_PATH" $WORKDIR/artifacts/${ARTIFACT_NAME}
              else
                echo "Error: box64 binary not found in $BUILD_DIR or $SOURCE_DIR"
                echo "Contents of $BUILD_DIR:"
                find $BUILD_DIR
                echo "Contents of $SOURCE_DIR:"
                find $SOURCE_DIR
                exit 1
              fi
            done
          done

      - name: Upload all artifacts
        if: env.skip_build != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: box64-artifacts-${{ env.ref }}-${{ matrix.arch }}
          path: artifacts/*
          if-no-files-found: ignore

  release-upload:
    name: Upload binaries to GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'release' && github.event.action == 'published') || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts

      - name: Create or update a release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name || github.sha }}
          name: "box64 ${{ github.ref_name || github.sha }}"
          body: |
            Automated build for:
            - Version/tag: ${{ github.event.inputs.version }}
            - Commit: ${{ github.event.inputs.commit }}
          draft: false
          prerelease: ${{ github.event_name != 'release' || github.event.action != 'published' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: build-artifacts/*/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}