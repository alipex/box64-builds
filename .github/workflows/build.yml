name: Build box64

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Box64 version (tag) to build (leave empty if using latest version)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-matrix:
    name: Build Box64 using matrix
    runs-on: self-hosted
    strategy:
      matrix:
        arch: [aarch64, rv64gc]
        dynarec: [true, false]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      ## This part of the workflow installs the required dependencies based on the architecture the program is being built for.
      ## It also sets up required tools that are necessary to start the bulding process.
      - name: Clone box64 source, install dependencies and prepare tools before building
        run: |

          skip_build = false
          skip_dynarec = false

          if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
          
            # Install dependencies for the aarch64 architecture
            sudo apt update && sudo apt install -y build-essential cmake git gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

          elif [[ "${{ matrix.arch }}" == "rv64gc" ]]; then

            # Install dependencies for the rv64gc architecture
            sudo apt update && sudo apt install -y build-essential cmake git gcc-riscv64-linux-gnu g++-riscv64-linux-gnu

          fi

      - name: Decide what to build
        id: set_ref
        run: |
          VERSION_INPUT="${{ github.event.inputs.version }}"
          if [[ -n "$VERSION_INPUT" ]]; then
            REF="$VERSION_INPUT"
            REF_TYPE="version"
          else
            latest_tag=$(git ls-remote --tags https://github.com/ptitSeb/box64 | awk -F/ '{print $3}' | grep -v '{}' | sort -V | tail -n1)
            REF="$latest_tag"
            REF_TYPE="version"
          fi
          echo "ref=$REF" >> $GITHUB_ENV
          echo "reftype=$REF_TYPE" >> $GITHUB_ENV

      - name: Clone box64 source
        run: |
          git clone https://github.com/ptitSeb/box64.git src
          cd src
          if [[ "${{ env.reftype }}" == "version" ]]; then
            git checkout "tags/${{ env.ref }}"

          else
            git checkout "${{ env.ref }}"
          fi

      - name: Check version support
        id: check_support
        run: |
          ver=$(echo ${{ env.ref }} | sed 's/v//')
          ver_num=$(echo $ver | awk -F. '{printf("%d%02d%02d",$1,$2,$3)}')
          
          skip_build=false
          skip_dynarec=false
          
          # RISC-V support from v0.1.8
          if [[ "${{ matrix.arch }}" == "rv64gc" && $ver_num -lt 10800 ]]; then
            skip_build=true
          fi
          
          # Dynarec support checks
          if [[ "${{ matrix.dynarec }}" == "true" ]]; then
            if [[ "${{ matrix.arch }}" == "aarch64" && $ver_num -lt 600 ]]; then
              skip_dynarec=true
            elif [[ "${{ matrix.arch }}" == "rv64gc" && $ver_num -lt 20400 ]]; then
              skip_dynarec=true
            fi
          fi
          
          echo "skip_build=$skip_build" >> $GITHUB_OUTPUT
          echo "skip_dynarec=$skip_dynarec" >> $GITHUB_OUTPUT

      - name: Build box64
        if: steps.check_support.outputs.skip_build != 'true' && steps.check_support.outputs.skip_dynarec != 'true'
        run: |
          WORKDIR=$GITHUB_WORKSPACE
          SOURCE_DIR=$WORKDIR/src
          BUILD_DIR=$WORKDIR/build-${{ matrix.arch }}-${{ matrix.dynarec }}
          
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          
          # Set up compiler and flags based on architecture
          if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
            SYSTEM_PROCESSOR="aarch64"
            C_COMPILER="aarch64-linux-gnu-gcc"
            CXX_COMPILER="aarch64-linux-gnu-g++"
          elif [[ "${{ matrix.arch }}" == "aarch64" ]]; then
            SYSTEM_PROCESSOR="riscv64"
            C_COMPILER="riscv64-linux-gnu-gcc"
            CXX_COMPILER="riscv64-linux-gnu-g++"
          fi
          
          # Configure build
          FLAGS="-DCMAKE_BUILD_TYPE=Release -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_PROCESSOR=$SYSTEM_PROCESSOR"
          FLAGS="$FLAGS -DCMAKE_C_COMPILER=$C_COMPILER -DCMAKE_CXX_COMPILER=$CXX_COMPILER"
          
          if [[ "${{ matrix.dynarec }}" == "true" ]]; then
            FLAGS="$FLAGS -DBUILD_DYNAREC=ON"
          else
            FLAGS="$FLAGS -DBUILD_DYNAREC=OFF"
          fi
          
          # BOX32 support (from v0.3.2)
          ver=$(echo ${{ env.ref }} | sed 's/v//')
          ver_num=$(echo $ver | awk -F. '{printf("%d%02d%02d",$1,$2,$3)}')
          if [[ $ver_num -ge 30302 ]]; then
            FLAGS="$FLAGS -DBUILD_BOX32=ON"
            BOX32_SUFFIX="-box32"
          else
            FLAGS="$FLAGS -DBUILD_BOX32=OFF"
            BOX32_SUFFIX=""
          fi
          
          cmake $SOURCE_DIR $FLAGS || { echo "CMake configuration failed"; exit 1; }
          make -j$(nproc) || { echo "make failed"; exit 1; }
          
          # Find and copy binary
          BINARY_PATH=$(find $BUILD_DIR -type f -name "box64" -executable | head -n1)
          if [[ -f "$BINARY_PATH" ]]; then
            mkdir -p $WORKDIR/artifacts
            cp "$BINARY_PATH" "$WORKDIR/artifacts/box64-${{ env.ref }}-${{ matrix.arch }}-${{ matrix.dynarec }}-${BOX32_SUFFIX}"
          else
            echo "Error: box64 binary not found"
            find $BUILD_DIR
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: box64-${{ env.ref }}-${{ matrix.arch }}-${{ matrix.dynarec }}
          path: artifacts/