name: Build and Release Box64

on:
  # push:
  #  tags:
  #    - '*'
  #release:
  #  types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Box64 version to build (leave empty for latest)'
        required: false
        default: ''

jobs:
  build:
    name: Build Box64
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64, rv64]
    env:
      BOX64_REPO: https://github.com/ptitSeb/box64.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set version
        id: set_version
        run: |
          # Default: manually specified version from workflow_dispatch
          VERSION_INPUT="${{ github.event.inputs.version }}"
          VERSION=""

          # If workflow_dispatch and version specified
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "$VERSION_INPUT" ]]; then
            VERSION="$VERSION_INPUT"

          # If push to a tag
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"

          # If release event
          elif [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"

          # Otherwise fallback to latest tag in repo
          else
            latest_tag=$(git ls-remote --tags $BOX64_REPO | awk -F/ '{print $3}' | sort -V | tail -n1)
            VERSION="$latest_tag"
          fi

          echo "Using version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake git gcc-aarch64-linux-gnu g++-aarch64-linux-gnu gcc-riscv64-linux-gnu g++-riscv64-linux-gnu

      - name: Clone Box64
        run: |
          git clone $BOX64_REPO box64-source
          cd box64-source

          # Check if version exists as a tag
          if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
            echo "Checking out tag $VERSION"
            git checkout tags/$VERSION
          else
            echo "Tag $VERSION not found, using main branch"
            git checkout main
          fi

      - name: Check architecture support
        id: check_arch
        run: |
          skip_build=false
          skip_optimized=false
          ver=$(echo ${{ env.version }} | sed 's/v//')
          ver_num=$(echo $ver | awk -F. '{printf("%d%02d%02d",$1,$2,$3)}')

          # RISC-V support from v0.1.8
          if [[ "${{ matrix.arch }}" == "rv64" && $ver_num -lt 10800 ]]; then
            echo "RISC-V not supported for version ${{ env.version }}"
            skip_build=true
          fi

          # DynaRec support
          if [[ "${{ matrix.arch }}" == "arm64" && $ver_num -lt 6 ]]; then
            skip_optimized=true
          elif [[ "${{ matrix.arch }}" == "rv64" && $ver_num -lt 204 ]]; then
            skip_optimized=true
          fi

          echo "skip_build=$skip_build" >> $GITHUB_ENV
          echo "skip_optimized=$skip_optimized" >> $GITHUB_ENV

      - name: Build regular and optimized versions
        if: env.skip_build != 'true'
        run: |
          mkdir -p artifacts
          for BUILD_TYPE in "regular" "optimized"; do
            if [[ "$BUILD_TYPE" == "optimized" && "${{ env.skip_optimized }}" == "true" ]]; then
              echo "Skipping optimized build for ${{ matrix.arch }} as DynaRec is not supported."
              continue
            fi

            BUILD_DIR=build-${BUILD_TYPE}-${{ matrix.arch }}
            mkdir -p $BUILD_DIR
            cd $BUILD_DIR

            FLAGS="-DCMAKE_BUILD_TYPE=Release"
            if [[ "$BUILD_TYPE" == "optimized" ]]; then
              FLAGS="$FLAGS -DBUILD_DYNAREC=ON"
            else
              FLAGS="$FLAGS -DBUILD_DYNAREC=OFF"
            fi

            # Embed Box32 from v0.3.2
            if [[ $ver_num -ge 30302 ]]; then
              FLAGS="$FLAGS -DBUILD_BOX32=ON"
            fi

            # Cross-compiler settings
            if [[ "${{ matrix.arch }}" == "arm64" ]]; then
              SYSTEM_PROCESSOR="aarch64"
              C_COMPILER="aarch64-linux-gnu-gcc"
              CXX_COMPILER="aarch64-linux-gnu-g++"
            else
              SYSTEM_PROCESSOR="riscv64"
              C_COMPILER="riscv64-linux-gnu-gcc"
              CXX_COMPILER="riscv64-linux-gnu-g++"
            fi

            cmake ../box64-source \
              -DCMAKE_SYSTEM_NAME=Linux \
              -DCMAKE_SYSTEM_PROCESSOR=$SYSTEM_PROCESSOR \
              -DCMAKE_C_COMPILER=$C_COMPILER \
              -DCMAKE_CXX_COMPILER=$CXX_COMPILER \
              $FLAGS

            make -j$(nproc)
            cd ../..

            # Copy built binary to artifacts folder
            OUTPUT_NAME="box64-${{ env.version }}-${BUILD_TYPE}-${{ matrix.arch }}"
            cp $BUILD_DIR/box64 artifacts/${OUTPUT_NAME}
            echo "${OUTPUT_NAME}" >> release_outputs.txt
          done

      - name: Upload build artifacts as job artifact
        if: env.skip_build != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: box64-artifacts-${{ env.version }}
          path: artifacts/*

      #- name: Create GitHub Release
      #  if: env.skip_build != 'true'
      #  uses: softprops/action-gh-release@v1
      #  with:
      #    tag_name: ${{ github.ref_name || env.version }}
      #    name: "Box64 ${{ github.ref_name || env.version }}"
      #    body: |
      #      Automated build for version ${{ github.ref_name || env.version }}.
      #      Includes architectures: ARM64, RV64 (as available).
      #      Build types: regular / optimized.
      #    draft: false
      #    prerelease: ${{ github.event_name != 'release' && github.event_name != 'push' }}
      #  env:
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set release outputs
        if: env.skip_build != 'true'
        run: |
          while read output; do
            echo "release_output=${output}" >> $GITHUB_OUTPUT
          done < release_outputs.txt

