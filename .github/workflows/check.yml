# .github/workflows/check-releases.yml
name: Check for new releases

on:
  schedule:
    - cron: '0 2 1,15 * *'  # 1st and 15th at 2 AM
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-releases:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Get latest release
      id: release
      run: |
        LATEST_TAG=$(curl -s "https://api.github.com/repos/ptitSeb/box64/releases/latest" | jq -r .tag_name)
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Latest release: $LATEST_TAG"
        
    - name: Check if already built
      id: check_built
      run: |
        # Initialize or load builds.json
        if [ -f builds.json ]; then
          echo "Loading existing builds.json"
        else
          echo "Creating new builds.json"
          echo '{"builds": [], "last_checked": ""}' > builds.json
        fi
        
        # Check if this version is already in builds.json
        VERSION="${{ steps.release.outputs.latest_tag }}"
        
        if jq -e --arg version "$VERSION" '.builds[] | select(.version == $version)' builds.json > /dev/null 2>&1; then
          echo "Version $VERSION already built"
          echo "already_built=true" >> $GITHUB_OUTPUT
        else
          echo "Version $VERSION not yet built"
          echo "already_built=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Update builds.json with check date
      run: |
        CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        jq --arg date "$CURRENT_DATE" '.last_checked = $date' builds.json > builds.json.tmp
        mv builds.json.tmp builds.json
        
    - name: Trigger build workflow
      if: steps.check_built.outputs.already_built == 'false'
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/dispatches \
          -d "{\"ref\":\"main\",\"inputs\":{\"version\":\"${{ steps.release.outputs.latest_tag }}\"}}"
        
    - name: Commit updated builds.json
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add builds.json
        git commit -m "Update builds.json check date" || echo "No changes to commit"
        git push